# PinPush (钉图) BMS

本项目是钉图BMS管理系统的MCU部分代码。项目代号为`PinPush`（钉图），因此大多数自研代码的文件、方法、变量和宏都以`pp`为前缀。

## 编码规范 (Coding Standards)

1.  **头文件保护**: 所有头文件都必须使用 `#pragma once` 来防止重复包含，而不是传统的 `#ifndef` 宏。
2.  **三方库修改追踪**: 当修改非 `app`, `boot` 目录下的文件时，必须添加 `//@changed` 格式的注释来追踪变更，以保持三方库的纯净性。
3.  **代码自解释**: 追求极致的简洁，代码本身应清晰地表达其意图。除了必要的版权和头文件说明，代码实现中不应包含功能性或解释性注释。
4.  **严格的契约式编程**: 
    *   大量且严谨地使用断言（`PP_ASSERT`）来定义和强制函数的前置条件、后置条件和不变量，尤其是在开发阶段。
5.  **错误处理**: 应用程序逻辑应专注于处理软件层面的错误。MCU核心硬件默认可靠，其问题由底层驱动解决。对于蓝牙、AFE、CAT1等易出错外设，其错误处理应在对应驱动层或模块中实现，并向上层提供明确的错误状态。
6.  **项目认知**: 始终将本项目视为一个全新且未曾接触过的项目。在开始任何工作之前，务必查阅相关文档和现有代码，充分了解项目背景和细节。

## 目录结构

### 3lib/
- **类型**: 外部代码
- **说明**: 存放三方库，开源项目源代码或商业产品的SDK。
- **结构**: 按项目或产品划分子目录。

### app/
- **类型**: 自研代码
- **说明**: BMS的核心应用代码。
- **子目录**:
    - `lib/`: BMS相关的通用代码，按模块划分子目录。
        - `pp_afe/`: BMS的AFE相关代码，按AFE FAMILY（`<AFE_FAMILY>`）划分子目录。
            - `<AFE_FAMILY/>`: 特定AFE FAMILY的驱动。
                - `misc/`: 特定AFE FAMILY的文档及示例代码等
    - `pcb/`: PCB硬件层的代码，按PCB编号（`<PCB_ID>`）划分子目录。
        - `<PCB_ID/>`: 特定PCB的硬件层代码。
            - `misc/`: PCB原理图等.
    - `prd/`: Product业务层的代码，按Product（`<PRD_ID>`）划分子目录。
        - `<PRD_ID/>`: 特定Product的业务代码。
            - `eide/`: EIDE插件的配置

### boot/
- **类型**: 自研代码
- **说明**: BOOTLOADER代码。
- **子目录**:
    - `drv/`: 为BOOTLOADER定制的MCU驱动，按MCU VENDOR划分子目录。
    - `lib/`: BOOTLOADER相关的通用代码，按模块划分子目录。
    - `soc/`: 针对不同MCU MODEL的BOOTLOADER代码，按MCU MODEL（`<MCU_FAMILY>`）划分子目录。
        - `<MCU_FAMILY/>`: 特定MCU MODEL的业务代码。
            - `eide/`: EIDE插件的配置

### mcu/
- **类型**: 外部代码
- **说明**: MCU厂商提供的源码。
- **结构**: 按MCU厂商（`<MCU_VENDOR>`）划分子目录。
    - `<MCU_VENDOR/`: 不同MCU VENDOR的源码，其中部分子目录按MCU MODEL（`<MCU_FAMILY>`）划分
        - `board/`: MCU芯片厂商提供的板级支持包。
        - `drivers/`: MCU芯片厂商提供的RT-THREAD驱动。
        - `<MCU_FAMILY/>`: 特定MCU FAMILY的源码。
            - `libraries/`: 特定MCU FAMILY的SDK
            - `misc/`: 特定MCU FAMILY的文档及示例代码等。

### rt-thread/
- **类型**: 外部代码
- **说明**: RT-THREAD操作系统的源码。

## Flash 分区结构与作用

Flash 分区定义主要位于 `app/pp_pcb_cmn_cfg.h` (定义分区大小和偏移宏) 和 `app/lib/pp_persist/fal_cfg.h` (定义Flash抽象层分区)。

该系统的Flash存储器被划分为多个逻辑分区，每个分区都承载着特定的功能和数据，共同支撑着设备的运行和固件管理。

以下是各个分区的详细作用：

1.  **`bootloader` 分区**
    *   **作用**：存储 `boot` 程序（引导程序）的代码。
    *   **在系统中的角色**：设备上电或复位后，`boot` 程序首先执行，负责系统初始化、固件更新管理，并最终启动 `app` 程序。

2.  **`bn_data` 分区**
    *   **作用**：一个已定义的Flash分区。
    *   **在系统中的角色**：在当前提供的代码中，没有发现对该分区的明确读写操作。它可能是一个保留分区，或用于存储未在当前代码中体现的数据。

3.  **`bl_data` 分区**
    *   **作用**：存储 `boot` 程序和 `app` 程序之间共享的通信数据和状态信息。
    *   **在系统中的角色**：该分区内容由 `app` 程序写入，`boot` 程序读取，用于传递固件更新指令、通信配置等关键信息。

4.  **`app` 分区**
    *   **作用**：存储 `app` 程序（主应用程序）的代码。
    *   **在系统中的角色**：是 `boot` 程序最终加载和运行的目标。固件更新时，新的 `app` 固件会被写入此分区。

5.  **`download` 分区**
    *   **作用**：作为新固件的临时存储区域。
    *   **在系统中的角色**：当 `app` 程序接收到新固件时，将其暂存于此。`boot` 程序在执行SOTA更新时，从该分区读取固件并写入 `app` 分区。

---

## 断言使用

1.  **总体原则**：断言用于发现编程错误，而非处理运行时错误。
2.  **函数声明**：对入参要做断言（用于发现编程错误）。
3.  **函数调用**：对返回值做断言（用于发现编程错误）。
4.  **执行逻辑**：对重要状态对断言。
